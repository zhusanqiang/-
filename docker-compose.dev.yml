# 开发时：docker-compose -f docker-compose.dev.yml up --build，只要您修改本地的 Python 代码，后端服务就会自动重启，您就能立刻看到修改后的结果。
version: '3.8'

services:
  redis:
    image: "redis:alpine"
    container_name: legal_doc_redis
    restart: always

  backend:
    container_name: legal_doc_backend
    build:
      context: ./backend
      dockerfile: Dockerfile
    env_file:
      - .env
    ports:
      - "8000:8000"
    volumes:
      # 在开发模式下，我们开启这个 volume 来实现代码同步
      - ./backend/app:/app/app
      - ./storage/uploads:/app/storage/uploads
      - ./storage/generated:/app/storage/generated
    depends_on:
      - redis
    # 关键修改：修改启动命令，让 uvicorn 开启 --reload 模式
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]

  frontend:
    # ... 前端配置可以保持不变，因为它本身就支持热更新 ...
    container_name: legal_doc_frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "8080:80"
    volumes:
      - ./frontend/src:/app/src 
      - ./frontend/public:/app/public
      - ./frontend/vite.config.ts:/app/vite.config.ts
      - ./frontend/package.json:/app/package.json
    depends_on:
      - backend
    restart: always
    environment:
      - VITE_API_BASE_URL=http://localhost:8000/api/v1

volumes:
  redis_data:
